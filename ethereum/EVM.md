# 以太坊虚拟机EVM

## 一.简介

- 以太坊虚拟机EVM是智能合约的运行环境
- 作为区块验证协议的一部分，参与网络中的**每一个节点**都会运行EVM，它们会检查正在验证的块中列出的交易，并运行由EVM中的交易触发的代码（智能合约）
- EVM不仅是沙盒封装的，而且是完全隔离的，EVM中的代码时无法访问网络，文件系统和其他进程，甚至智能合约之间的访问也是受限的（保证系统的安全性）
- 合约以字节码的格式储存在区块链上
- 合约通常用高级语言（solidity）编写，通过EVM编译器编译为字节码，最终通过客户端上载部署到区块链网络中

## 二.EVM和账户

- 外部账户和合约账户公用EVM中的同一个地址空间

- 以上两类账户对EVM的处理方式完全一样

- 每个账户在EVM中都有一个键值对形式的**持久化储存**，其中key和value都是256位，称之为**储存空间**，调用这个空间要消耗大量gas
##三.EVM和交易
- 交易可以看作时一个账户给另一个账户法的消息，他可以包含二进制数据(payload)和以太币
- 如果目标账户含有代码，可以根据交易时，调用者所指定的函数名和参数来在EVM中调用此代码(以payload作为参数)
- 如果目标账户是0账户，交易将建立一个新合约，这个用来创建合约的交易的payload会被转换为EVM字节码并执行，执行的输出作为合约代码永久存储
##三.EVM和gas
- 消耗算例成本时，每一个指令的执行都有特定的消耗，gas量化了这个消耗，最少是21000wei（只转账）。
- EVM交易时，gas将按照特定规则逐渐耗尽
- gas price越大，越有可能被矿工执行
- gas耗尽则触发异常，并回滚
##四.EVM数据存储
###Storage

- 每个账户都有一个持久化存储空间，称之为storage，是一个将256位字映射到256位字的key-value存储区，类似于为合约的数据库
- 永久储存在区块链中，gas开销是数据存储中最大的
- Storage非常大，虽然它本质是一个hash表，但是它是没办法遍历的，它的hash表是双重hash之后的hash表，时间复杂度极高

### Memory（内存）

- 每一次消息调用，合约会临时获取到一块内存中
- 生命周期是整个方法执行期间，调用后回收，仅仅保存临时变量，读写gas消耗较小
- Memory消耗的gas增长并不是线性的，是平方级别的增长，所以要少用

### Stack（栈）

- EVM是基于栈的，所有的计算都是在栈中执行
- 寄存部分**局部值**类型变量，几乎免费，但有数量限制

## 五.EVM指令集

- 所有的指令都是针对**256位的字**这个基本数据类型来操作的

- 常规的比较，位运算，跳转什么的都行

- 合约可以访问当前区块的相关属性，如块高度和时间戳

## 六.消息调用
- 合约可以通过**消息调用**的方式调用其他合约或者发送以太币到合约账户
- 合约可以决定在其内部的消息调用中，对于剩余的gas应发送多少和要保留多少
- 如果内部消息调用时发生了out-of-gas异常，这将由一个被压入栈顶的错误值所指明，此时只有与该内部消息调用一起发送的gas会被消耗掉
## 七.委托调用
​    U用户调用A合约，A合约调用B合约，B合约的msg.sender是A合约。使用委托调用的时候，B合约的msg.sender就成为了U用户。

​	因此可以靠这种方式来实现一个代码库

## 八.合约的创建和自毁

- 合约A通过create calls，可以创建其他合约B，但是这个合约B并不会添加到链上，而是会保存在内存里
- 合约可以在本身的合约中执行自毁操作selfdestruct，合约账户上剩余的以太币会发送给指定的目标。





